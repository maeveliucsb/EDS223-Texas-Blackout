---
title: "Texas_Blackout_analysis"
author: "Maeve Li Oak"
date: '11/7/2025'
format: html
editor: visual
embed-resources: true
page-loading: false
code-fold: show
execute: 
  warning: false
  message: false
toc: TRUE
---

### Read Me Screenshot


### Loading Packages

This portion of the document loads all the packages necessary to complete the rest of the document. The goal of this project is to analyze the impact of climate change induced extreme weather events through an analysis of the 2021 Texas blackouts. The data for this project will be focused on remotely sensed night lights data as a identifier for areas which lost power.

```{r}

library(tidyverse) # data wrangling
library(sf) # for spatial data
library(tmap) # for pretty maps
library(here) # file pathing
library(viridisLite) # colors
library(janitor) # data wrangling
library(kableExtra) # pretty table
library(patchwork) # combine plots
library(stars) # rasters
library(terra) # rasters
library(tidycensus) #for income data later
```
### Reading in Data
This portion reads in the lights data using read_stars, there are two tiles per day for each half of Huston, creating a total of 4 data frames to read in. 

```{r}
# load in data 

# t5 date 1
tile5_2.7 <- read_stars(here::here("data","VNP46A1", "VNP46A1.A2021038.h08v05.001.2021039064328.tif"),
               quiet = TRUE) # hide the message

# t6 date 1
tile6_2.7 <- read_stars(here::here("data",
"VNP46A1",
"VNP46A1.A2021038.h08v06.001.2021039064329.tif"),
               quiet = TRUE) # hide the message

# t5 date 2
tile5_2.16 <- read_stars(here::here("data","VNP46A1", "VNP46A1.A2021047.h08v05.001.2021048091106.tif"),
               quiet = TRUE) # hide the message

# t6 date 2
tile6_2.16 <- read_stars(here::here("data","VNP46A1", "VNP46A1.A2021047.h08v06.001.2021048091105.tif"),
               quiet = TRUE) # hide the message

```

This portion reads in the roads data, I'll use this later to isolate the effect of the blackout. 

```{r}
road <- st_read(here::here("data", "gis_osm_roads_free_1.gpkg"),
query = "SELECT * FROM gis_osm_roads_free_1 WHERE fclass='motorway'", 
quiet = TRUE) %>% # hide the message
  st_make_valid() # valid geo
```
This portion reads in the house/residential data, this will be used later to identify what houses lost power. 
```{r}

house <- st_read(here::here("data", "gis_osm_buildings_a_free_1.gpkg"),
 query = "SELECT *
    FROM gis_osm_buildings_a_free_1 
    WHERE (type IS NULL AND name IS NULL)
    OR type in ('residential', 'apartments', 
'house', 'static_caravan', 'detached')", #loading in only the home data
              quiet = TRUE) %>% # hide the message
              st_make_valid() # valid geo
```

This final data portion reads in the Socioeconomic data, because the file is so big, I've loaded in the geometry, the income and the meta data, to make it easier to maneuver. 

```{r}
# geography layer
geo <- st_read(here::here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"),
   layer = "ACS_2019_5YR_TRACT_48_TEXAS", # specify the layer to read in
    quiet = TRUE) %>% # no long message
    st_make_valid() %>% # valid geometry
    dplyr::select(GEOID_Data, Shape) %>% # keep only needed columns
    rename(GEOID = GEOID_Data) # name to match colname in income

# income layer
income <- st_read(here::here("data", 
                          "ACS_2019_5YR_TRACT_48_TEXAS.gdb"),
    layer = "X19_INCOME", # specify the layer to read in for income (from exploration)
               quiet = TRUE)  # no long message

# metadata (colnames)
meta <- st_read(here::here("data", "ACS_2019_5YR_TRACT_48_TEXAS.gdb"),
              layer = "TRACT_METADATA_2019", # specify the layer to read in for income (from exploration)
               quiet = TRUE) %>% 
              # only keep metadata related to income
              filter(str_detect(Full_Name, 
                regex("INCOME", ignore_case = TRUE)))
```


### Making the blackout mask

This portion creates a mask that shows if a Texas cell had a blackout. In order to do this I need to find the change in night lights caused by the storm, which means I have to to make a raster object for each day. To do this I combine light data from two areas (area 05, and area 06) of Texas into a raster for each day (Feb 7th and 16th).

First I combine the two tiles for days 1 and 2, and then check to make sure the CRSs are the same, so we can work with them together. 

```{r}
# combine tiles 5 and 6 for feb 7th
d1 <- st_mosaic(tile5_2.7, tile6_2.7)
# combine tiles 5 and 6 for feb 16th
d2 <- st_mosaic(tile5_2.16, tile6_2.16)

#checking CRS!

if(st_crs(d1) == st_crs(d2)) {
  print("CRS's are the same!")
} else{
  d2_stars <- st_transform(d1_stars, crs = st_crs(d1))
}

```

In this portion I take the income data, and I keep only the GEOID and median income (for all households) row (Short name: B19113e1, pulled from the meta data, long name: "MEDIAN FAMILY INCOME IN THE PAST 12 MONTHS (IN 2019 INFLATION-ADJUSTED DOLLARS): Median family income in the past 12 months (in 2019 inflation-adjusted dollars): Families"). I then filter

```{r}

#looking for the right variable in the meta data
meta_income <- meta |>
  mutate(full_name_clean = make_clean_names(Full_Name)) |>
  filter(
    str_detect(full_name_clean, "median") &
    str_detect(full_name_clean, "income") &
    str_detect(full_name_clean, "inflation_adjusted")
  )

# looking at the columns, there are a TON
#meta_income |> select(Short_Name, Full_Name) commented out because its so long

#I picked B19113m1, which seemed the most appropriate "MEDIAN FAMILY INCOME IN THE PAST 12 MONTHS (IN 2019 INFLATION-ADJUSTED DOLLARS): Median family income in the past 12 months (in 2019 inflation-adjusted dollars): Families"
income_filtered <- income |>
  transmute(
    GEOID,
    median_income_inflation_adj = B19113e1
  )


#I then make sure that it keeps its geometry based on the 'shape' column, for some reason it was giving me an error that it wasn't spatial.
geo <- st_as_sf(
  geo,
  wkt = "Shape"
)

# Making income filtered, and my geometry data one data frame which live together
se <- geo |>
  left_join(income_filtered, by = "GEOID") |>
  st_make_valid() |>
  st_transform("EPSG:4326")
class(se) # Has become spatial
```


## Difference

In this portion, I take day 1 and day 2 data, and I identify the difference from the two. I then the values that are less than 200 radiance in a boolean (less than 200 = false, more than 200 = true), and set all the falses to NA, this allows me to see where light intensity dropped. 

```{r}

# Difference raster
diff <- d1 - d2

# subtracting for less than 200
diff_stars <- d1 - d2 > 200

# set the FALSE (less than 200) to NA
diff_stars[diff_stars==FALSE] <- NA

```

# Vectorizing

This portion turns the raster into a vector, and fixes invalid geometry. Then I just use st_is_valid to make sure all the geometries are valid.

```{r}
diff_vect <- st_as_sf(diff_stars) %>% 
  st_make_valid() 
```


# Cropping

This portion crops the blackout mask to the Huston area, using these coordinates: (-96.5, 29), (-96.5, 30.5), (-94.5, 30.5), (-94.5, 29) then it is vectorized into a layer. 

```{r}
# mmaking a bbox
crop_bbox <- st_bbox(c( 
  xmin = -96.5,
  ymin = 29,
  xmax = -94.5,
  ymax = 30.5),
  crs = st_crs(diff_vect)) # ensure same crs as the difference vector

# convert into a layer
crop <- st_as_sfc(crop_bbox) # then i make it a layer

# check extent
st_bbox(crop)

## now crop the actual blackout mask

diff_crop <- diff_vect[crop, ] # keep all rows that intersect with the crop  
```

# Re-projecting
This portion re-projects the cropped dataset to EPSG:3083 using st_transform

```{r}
croppeddiff <- diff_crop %>%
  st_transform("EPSG:3083")
```

# Excluding Freeways

This portion begins the freeway exclusion portion. Because road lights vary significantly independently of blackouts, they will skew our data and make it difficult to see the extent of the blackout. 

In order to do this, I start by transforming the road so that the CRS matches all the other work I've done (croppeddiff), then I buffer by 200 meters around the road. 
```{r}
road_trans <- road %>% 
  st_transform("EPSG:3083") 

# Buffering
road_buffer_200m <- st_buffer(road_trans, dist = 200)
```
I then combine all the little buffers into one big polygon buffer so that its easier to work with 

```{r}
road_buffer_200m <- st_union(road_buffer_200m)
```

Now, with the buffer, I find spaces that have experienced blackouts and are also farther than 200 meters from the freeway. This should allow me to visualize the extent of the blackout without interference. 

I'm going to take observations from outside the buffer layer by taking the difference of the buffered road polygon from the cropped difference blackout areas I made previously. 

```{r}
# outside the buffer
no_freeway <- st_difference(croppeddiff, road_buffer_200m) # creates polygon of the area of x not in y

```
# Homes impacted by blackouts. 
using all of the above information, now I can make a map of the homes in Huston likely impacted by blackouts

```{r}

tm_shape(no_freeway) +
  tm_polygons(col = "green") +
  tm_basemap("OpenStreetMap") +
  tm_graticules() +
  tm_layout(
    title = "Areas in Houston Likely Impacted By Blackouts",
    title.position = tm_pos_out("center", "top"),  
  )
```

# Maps 1 and 2

This portion creates maps which illustrate the night light intensity before and after the storms in radiance. 

In order to do this properly, I first need to crop each day data set to the bbox we used before, then I transform the road CRS and crop that as well. Then finally to ensure that the difference is visible, I create a custom palette using Viridis Mako, but amended slightly such that the contrast is more clear. 

```{r}
tmap_mode("plot") 
# Cropping rasters to that bbox-for the purpose of building Vis. 1, cropping days 1/2 visualization data
d1_hou <- st_crop(d1, crop_bbox)
d2_hou <- st_crop(d2, crop_bbox)

# Put roads in same CRS, crop them 
roads_ll  <- st_transform(road_trans, st_crs(d1))
roads_hou <- st_crop(roads_ll, crop_bbox)


# palette with no true black-shows the contrast better
pal_radiance <- mako(9, begin = 0.2, end = 1)


#building the maps
m_before <- tm_shape(d1_hou) +
  tm_scalebar() +
  tm_raster(
    style   = "cont",
    palette = pal_radiance,
    title   = "Radiance (Feb 7)"
  ) +
  tm_shape(road_trans) + tm_lines(col = "grey30", lwd = 0.6) +
  tm_layout(
    main.title = "Areas in Houston With Electricity: Before Storm",
    frame      = FALSE
  )


m_after <- tm_shape(d2_hou) +
  tm_scalebar() +
  tm_raster(
    style   = "cont",
    palette = pal_radiance,
    title   = "Radiance (Feb 16)"
  ) +
  tm_shape(road_trans) + tm_lines(col = "grey30", lwd = 0.6) +
  tm_layout(
    main.title = "Areas in Houston With Electricity: After Storm",
    frame      = FALSE
  )
  
tmap_arrange(m_before, m_after, ncol = 2)

```

# Map of homes in Huston that lost power by Census tract

This portion then analyzes the impact of the blackout by census tract. This enables an environmental justice perspective on how different census tracts experienced the impacts of the storm. 

First I transform the CRS of my house data set, and fix any invalid geometries. Then I filter to make sure that none are within my road polygons data set. I then add a column which indicates if a house did or did not experience a blackout (Y if they did). I then pull the osm_id to filter. 

```{r}
house_trans <- house %>% 
   st_transform("EPSG:3083") %>% 
  st_make_valid()

# homes in the blackout area
blackedout <- st_filter(house_trans, no_freeway, .predicate = st_within) %>% 
  mutate(blackout = "Y") # column saying this home did experience a blackout

#checking to make sure that everything is done right! 
nrow(blackedout) # 138,404
unique(st_is_valid(blackedout)) # TRUE

# OSM Ids for filtering. 
blackout_ids <- unique(blackedout$osm_id)
```

In this portion I identify the amount of homes not affected by the blackouts doing the same thing as before, but filtered inversely (taking the blackout home IDs and omitting them, and any homes that remain get tagged with an N in the blackout column)
```{r}
# homes not affected will be the rest of the homes
alight <- house_trans %>% 
 filter(!osm_id %in% blackout_ids) %>% 
  mutate(blackout = "N") 

nrow(alight) # looking at how many homes remained alight
```
This portion combines both the blacked out data and the alight data with the all homes in Huston (not within 200 meters of the freeway). I then check to make sure they all have the same CRS, and then comine it with the socioeconomic data. 
```{r}
homes_blackout_yn <- bind_rows(blackedout, alight)

# check and ensure crs
se <- se %>%
   st_transform("EPSG:3083") %>% 
  st_make_valid() 

# adding all the homes info with SE data
homes_allinfo <- st_join(homes_blackout_yn, se, # join the two
                         join = st_within, left = TRUE) 
```

I then bring that into a tract level summary. I first drop all the geometry, filter NAs and group by geoID. Then I summarize the amount of homes in the tract, how many had blackouts, and a dummy variable for visibility. 

```{r}
census_lvl <- homes_allinfo %>% 
  st_drop_geometry() %>% # for wrangling
  filter(!is.na(GEOID)) %>% 
 group_by(GEOID) %>%
  summarize(
    n_homes = n(), # how many homes in the tract
    n_blackout = sum(blackout == "Y", na.rm = TRUE), # how many had blackout
    blackout_yn   = if_else(n_blackout > 0, "Y", "N"), # yes or no 
  .groups = "drop")
```
Then I join the tract level stats back into spatial level data frames. 
```{r}

census_lvl_spatial <- left_join(se, census_lvl, by = "GEOID") %>%
  filter(!is.na(n_homes)) 

```

This portion creates the map!
```{r}
map_census <- tm_basemap("Esri.WorldGrayCanvas") +
  tm_graticules() +
  tm_shape(census_lvl_spatial, bbox = st_bbox(homes_blackout_yn)) +
    tm_borders(col = "white") +
    tm_polygons(
      fill = "blackout_yn",
      fill.scale = tm_scale(values = c("white", "magenta")),
      fill.legend = tm_legend(
        title = "Presence of blackout",
        position = tm_pos_out("right")
      )) +
  tm_title("Census Tracts that Experienced a Blackout in Houston in 2021")

map_census
```

# Estimate of the number of homes in Huston that lost power
To do this, I just take the total row count of the number of homes in Huston that lost power. The total homes in Huston which lost power are 138,400

```{r}
nrow(blackedout) # 138,400
```

# (GG)Plot comparing the distributions of median household income for census tracts that did and did not experience blackouts

This portion I'm taking the data which shows where the blackouts were, and then plotting the median household income of those that did and didn't experience blackouts. 

To do this I combine the census level information, and drop the geometry to make it easier to work with. I then take the median income row I pulled from the meta data earlier, with the blackout information, and then plot them as overlapping histograms. 

```{r}
ggplot(
  census_lvl_spatial |> st_drop_geometry(),  # drop geometry for safety
  aes(
    x    = median_income_inflation_adj,
    fill = blackout_yn
  )
) +
  geom_histogram(
    position = "identity",
    alpha    = 0.5,
    bins     = 30
  ) +
  scale_fill_manual(
    values = c("Y" = "#E69F00", "N" = "#ff00ff"),
    labels = c("Y" = "Yes", "N" = "No"),  # legend labels
    name   = "Blackout"
  ) +
  labs(
    x     = "Median Household Income ($)",
    y     = "Number of Census Tracts",
    title = "Income Distribution of Houston Census Tracts\nby Blackout Experience"
  ) +
  theme_minimal(base_size = 14)

```

# Result Summary

This document calculates the different effects of large scale climate weather events on different socioeconomic groups through the mapping of the 2020 Huston blackouts, caused by an unprecedentedly large snow storm. A total of over 6,000 homes lost power, primarily in low income areas (a median income of approximately \$50,000). These patterns illustrate that low income households appear to bear the brunt of the impacts of large scale climate events, and higher income households are more resillient to the negative effects of climate change
